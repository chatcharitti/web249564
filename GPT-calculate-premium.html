<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AIA Premium Table Reference 2025 (HS/HSX/HSV/HH) FINAL ALL-IN-ONE</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Sarabun', sans-serif; background: #0b1220; }
    .sticky-header { position: sticky; top: 0; z-index: 60; }
    .sticky-col { position: sticky; left: 0; z-index: 30; background-color: rgba(255,255,255,0.96); backdrop-filter: blur(6px); }

    .glass { background: rgba(255,255,255,0.08); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.12); }
    .card { border-radius: 18px; }
    .shadow-premium { box-shadow: 0 22px 60px rgba(0,0,0,0.45); }

    .fade-in { animation: fadeIn 0.25s ease-out; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(5px);} to { opacity:1; transform: translateY(0);} }
    tr:hover td { background-color: #fff7ed; transition: 0.08s; }

    .btn { transition: 0.15s transform, 0.15s opacity; }
    .btn:active { transform: scale(0.98); }
    .cta { background: linear-gradient(135deg, #f59e0b, #ec4899); }
    .cta:hover { opacity: 0.95; }

    @media print {
      body { background: white !important; }
      .sticky-header { position: relative !important; }
      #validator-panel { display:none !important; }
    }
  </style>
</head>

<body class="text-slate-100">
<div class="max-w-[1700px] mx-auto my-6 px-3">

  <!-- HEADER -->
  <div class="sticky-header card shadow-premium overflow-hidden">
    <div class="bg-gradient-to-r from-indigo-950 via-slate-900 to-zinc-950 px-5 py-5">
      <div class="flex flex-col lg:flex-row justify-between items-center gap-4">

        <div class="flex items-center gap-3">
          <div class="bg-gradient-to-br from-amber-500 to-rose-500 p-2.5 rounded-2xl shadow-inner">
            <i data-lucide="sparkles" class="w-7 h-7 text-white"></i>
          </div>
          <div>
            <h1 class="text-xl md:text-2xl font-extrabold tracking-tight">
              ตารางเบี้ย/ความคุ้มครอง AIA (FINAL)
            </h1>
            <p class="text-xs text-slate-300">
              HS หน้า 3 · HSX หน้า 6 · HSV หน้า 9 · HH หน้า 12 · รองรับอายุถึง 98 · FIX mapping แล้ว · validateRateTable กันค่า 0
            </p>
          </div>
        </div>

        <!-- Controls -->
        <div class="glass px-3 py-2 rounded-2xl flex flex-wrap items-end gap-3">
          <div>
            <label class="block text-[10px] text-amber-200 mb-1 font-bold uppercase tracking-wider">เพศ</label>
            <select id="input-gender" onchange="app.reCalculate()"
              class="bg-black/60 border border-white/20 text-white text-sm rounded-xl px-3 py-2 outline-none w-28">
              <option value="male">ชาย</option>
              <option value="female">หญิง</option>
            </select>
          </div>

          <div>
            <label class="block text-[10px] text-amber-200 mb-1 font-bold uppercase tracking-wider">อายุปัจจุบัน</label>
            <input type="number" id="input-age" value="35" min="11" max="98" onchange="app.reCalculate()"
              class="bg-black/60 border border-white/20 text-white text-sm rounded-xl px-3 py-2 w-24 text-center outline-none">
          </div>

          <div class="flex gap-2">
            <button onclick="app.reCalculate()"
              class="btn cta text-white text-sm font-extrabold py-2 px-4 rounded-xl shadow-md flex items-center gap-2">
              <i data-lucide="calculator" class="w-4 h-4"></i>
              <span>คำนวณ</span>
            </button>

            <button onclick="app.toggleProMode()"
              class="btn bg-white/10 hover:bg-white/15 border border-white/20 text-white text-sm font-bold py-2 px-4 rounded-xl flex items-center gap-2">
              <i data-lucide="briefcase" class="w-4 h-4"></i>
              <span id="pro-mode-label">โหมดเซลล์มืออาชีพ: OFF</span>
            </button>

            <button onclick="app.adjustFont(+1)"
              class="btn bg-white/10 hover:bg-white/15 border border-white/20 text-white text-sm font-bold py-2 px-3 rounded-xl">A+</button>
            <button onclick="app.adjustFont(-1)"
              class="btn bg-white/10 hover:bg-white/15 border border-white/20 text-white text-sm font-bold py-2 px-3 rounded-xl">A-</button>
            <button onclick="app.adjustFont(0)"
              class="btn bg-white/10 hover:bg-white/15 border border-white/20 text-white text-sm font-bold py-2 px-3 rounded-xl">Reset</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Sell Banner -->
    <div id="sell-banner" class="hidden bg-gradient-to-r from-emerald-500/15 via-amber-400/15 to-rose-500/15 border-t border-white/10 px-5 py-3">
      <div class="flex flex-col md:flex-row gap-3 items-start md:items-center justify-between">
        <div class="text-sm text-slate-100">
          <div class="font-extrabold">✅ โหมดเซลล์มืออาชีพ</div>
          <div class="text-xs text-slate-200 mt-1">
            A = คุ้มค่า · B = สมดุล · C = พรีเมียม (เหมาจ่ายวงเงินสูง)
          </div>
        </div>
        <div class="text-xs text-slate-100 bg-black/35 border border-white/10 px-3 py-2 rounded-xl">
          “ค่ารักษาหลักแสน-ล้าน เป็นสิ่งไม่แน่นอน — เลือกเตรียมการป้องกันไว้ตั้งแต่วันนี้”
        </div>
      </div>
    </div>
  </div>

  <!-- PLAN SELECTION -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4">
    <div class="glass card p-3 border border-white/10">
      <div class="flex justify-between mb-2">
        <span class="text-[11px] font-extrabold text-emerald-200 bg-emerald-500/15 px-2 py-1 rounded-xl">PLAN A</span>
        <span class="text-[10px] text-slate-300">คุ้มค่า</span>
      </div>
      <select id="type-1" onchange="app.changeType(1,this.value)"
        class="w-full text-sm font-bold p-2.5 rounded-xl border border-white/15 bg-black/40 text-white mb-2"></select>
      <select id="idx-1" onchange="app.changeOption(1,this.value)"
        class="w-full text-sm p-2.5 rounded-xl border border-white/15 bg-black/30 text-white"></select>
    </div>

    <div class="glass card p-3 border border-white/10">
      <div class="flex justify-between mb-2">
        <span class="text-[11px] font-extrabold text-sky-200 bg-sky-500/15 px-2 py-1 rounded-xl">PLAN B</span>
        <span class="text-[10px] text-slate-300">สมดุล</span>
      </div>
      <select id="type-2" onchange="app.changeType(2,this.value)"
        class="w-full text-sm font-bold p-2.5 rounded-xl border border-white/15 bg-black/40 text-white mb-2"></select>
      <select id="idx-2" onchange="app.changeOption(2,this.value)"
        class="w-full text-sm p-2.5 rounded-xl border border-white/15 bg-black/30 text-white"></select>
    </div>

    <div class="glass card p-3 border border-white/10">
      <div class="flex justify-between mb-2">
        <span class="text-[11px] font-extrabold text-pink-200 bg-pink-500/15 px-2 py-1 rounded-xl">PLAN C</span>
        <span class="text-[10px] text-slate-300">พรีเมียม</span>
      </div>
      <select id="type-3" onchange="app.changeType(3,this.value)"
        class="w-full text-sm font-bold p-2.5 rounded-xl border border-white/15 bg-black/40 text-white mb-2"></select>
      <select id="idx-3" onchange="app.changeOption(3,this.value)"
        class="w-full text-sm p-2.5 rounded-xl border border-white/15 bg-black/30 text-white"></select>
    </div>
  </div>

  <!-- MAIN -->
  <div class="mt-4 bg-white rounded-2xl overflow-hidden shadow-premium border border-white/10">

    <!-- Current premium -->
    <div class="overflow-x-auto">
      <table class="w-full min-w-[1100px] border-collapse text-sm">
        <thead>
          <tr class="bg-gradient-to-r from-emerald-50 via-white to-amber-50 border-b border-emerald-100">
            <th class="p-4 text-left sticky-col border-r border-gray-200 z-10 w-[25%]">
              <div class="flex items-center gap-2 text-emerald-900 font-extrabold text-base">
                <i data-lucide="coins" class="w-5 h-5 text-emerald-600"></i> เบี้ยประกันปีปัจจุบัน
              </div>
              <div id="debug-band" class="text-[10px] font-bold text-emerald-700 mt-1 pl-7"></div>
            </th>
            <th id="prem-1" class="p-4 text-center text-3xl font-black text-emerald-700 w-[25%] border-r border-emerald-100">-</th>
            <th id="prem-2" class="p-4 text-center text-3xl font-black text-emerald-700 w-[25%] border-r border-emerald-100">-</th>
            <th id="prem-3" class="p-4 text-center text-3xl font-black text-emerald-700 w-[25%]">-</th>
          </tr>
          <tr class="bg-white border-b-4 border-gray-100">
            <th class="p-4 text-left sticky-col bg-white border-r border-gray-200 z-10 align-top">
              <span class="text-lg font-black text-gray-800">รายละเอียด</span>
            </th>
            <th id="head-1" class="p-4 align-top border-r border-gray-100"></th>
            <th id="head-2" class="p-4 align-top border-r border-gray-100"></th>
            <th id="head-3" class="p-4 align-top"></th>
          </tr>
        </thead>
        <tbody id="table-body" class="divide-y divide-gray-100 text-gray-700"></tbody>
      </table>
    </div>

    <!-- Premium projection -->
    <div class="m-4 md:m-8 border border-gray-200 rounded-2xl overflow-hidden shadow-lg bg-white">
      <div class="bg-gradient-to-r from-slate-950 via-slate-900 to-zinc-950 text-white p-4 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i data-lucide="trending-up" class="w-5 h-5 text-amber-400"></i>
          <h2 class="text-lg font-black">ตารางเบี้ยต่อเนื่อง (ถึงอายุ 98) — FIXED</h2>
        </div>
        <span class="text-xs text-slate-200 bg-white/10 px-2 py-1 rounded-lg border border-white/10">
          ช่วงอายุสีแดง
        </span>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-sm text-center">
          <thead class="bg-slate-100 text-slate-600 font-black border-b border-gray-200">
          <tr>
            <th class="p-3 w-[15%]">ช่วงอายุ</th>
            <th class="p-3 w-[28%]" id="proj-head-1">PLAN A</th>
            <th class="p-3 w-[28%]" id="proj-head-2">PLAN B</th>
            <th class="p-3 w-[28%]" id="proj-head-3">PLAN C</th>
          </tr>
          </thead>
          <tbody id="premium-table-body" class="divide-y divide-gray-100"></tbody>
        </table>
      </div>

      <div class="p-3 bg-slate-50 text-[10px] text-slate-500 text-center border-t border-gray-200">
        * อายุมีเครื่องหมาย * หมายถึงปีต่ออายุ (76-80*, 81-85*, ... 96-98*)
      </div>
    </div>

    <!-- Validation -->
    <div class="px-5 pb-6">
      <div class="bg-amber-50 border border-amber-200 rounded-2xl p-4">
        <div class="flex items-start gap-2">
          <i data-lucide="shield-check" class="w-5 h-5 text-amber-600 mt-0.5"></i>
          <div>
            <div class="font-black text-amber-900">ตรวจสอบความครบของตาราง (validateRateTable)</div>
            <div class="text-xs text-amber-800 mt-1">
              หากมีเบี้ยเป็น 0 / ตารางไม่ครบ / index ผิด ระบบจะแสดงรายการเตือนทันที
            </div>
            <div id="validation-box" class="mt-2 text-xs text-amber-900 font-bold"></div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Floating Validation Panel -->
<div id="validator-panel" class="fixed bottom-4 right-4 z-[9999] hidden max-w-md">
  <div class="bg-red-600 text-white rounded-2xl shadow-2xl border border-red-200 overflow-hidden">
    <div class="px-4 py-3 font-extrabold text-sm flex items-center justify-between">
      <span>⚠️ RateTable ไม่สมบูรณ์</span>
      <button onclick="document.getElementById('validator-panel').classList.add('hidden')" class="text-white/90 hover:text-white font-extrabold">✕</button>
    </div>
    <div id="validator-body" class="px-4 py-3 text-xs bg-white text-slate-800 max-h-64 overflow-auto"></div>
    <div class="px-4 py-2 bg-red-50 text-[10px] text-red-700 border-t border-red-100">
      * รายละเอียดเต็มดูใน Console (F12)
    </div>
  </div>
</div>

<script>
const app = {
  ui: { proMode: false, fontScale: 0 },

  AGE_BANDS_STD: [
    "11-15","16-20","21-25","26-30","31-35",
    "36-40","41-45","46-50","51-55",
    "56-60","61-65","66-70","71-75",
    "76-80*","81-85*","86-90*","91-95*","96-98*"
  ],

  AGE_BANDS_HH: [
    "11-15","16-20","21-25","26-30","31-35",
    "36-40","41-45","46-50","51-55",
    "56-59","60-65",
    "66-70","71-75",
    "76-80*","81-85*","86-90*","91-95*","96-98*"
  ],

  plans: {
    HS: { name: "H&S new standard (HS)", subtitle: "อ้างอิงเบี้ยหน้า 3",
      options: [
        { name: "แผน 1000", rateKey: "1000", limit: "แยกหมวด" },
        { name: "แผน 1600", rateKey: "1600", limit: "แยกหมวด" },
        { name: "แผน 2200", rateKey: "2200", limit: "แยกหมวด" },
        { name: "แผน 2800", rateKey: "2800", limit: "แยกหมวด" },
        { name: "แผน 3400", rateKey: "3400", limit: "แยกหมวด" },
        { name: "แผน 4000", rateKey: "4000", limit: "แยกหมวด" },
        { name: "แผน 5000", rateKey: "5000", limit: "แยกหมวด" }
      ]
    },
    HSX: { name: "H&S Extra (HSX)", subtitle: "อ้างอิงเบี้ยหน้า 6",
      options: [
        { name: "แผน 1500", rateKey: "1500", limit: "ไม่จำกัด" },
        { name: "แผน 2000", rateKey: "2000", limit: "ไม่จำกัด" },
        { name: "แผน 2500", rateKey: "2500", limit: "ไม่จำกัด" },
        { name: "แผน 3500", rateKey: "3500", limit: "ไม่จำกัด" },
        { name: "แผน 4500", rateKey: "4500", limit: "ไม่จำกัด" },
        { name: "แผน 5500", rateKey: "5500", limit: "ไม่จำกัด" },
        { name: "แผน 6500", rateKey: "6500", limit: "ไม่จำกัด" }
      ]
    },
    HSV: { name: "Health Saver (HSV)", subtitle: "อ้างอิงเบี้ยหน้า 9",
      options: [
        { name: "แผน 200k", rateKey: "200k", limit: "200,000" },
        { name: "แผน 300k", rateKey: "300k", limit: "300,000" },
        { name: "แผน 400k", rateKey: "400k", limit: "400,000" },
        { name: "แผน 500k", rateKey: "500k", limit: "500,000" }
      ]
    },
    HH: { name: "Health Happy (HH)", subtitle: "อ้างอิงเบี้ยหน้า 12 · band พิเศษ",
      options: [
        { name: "แผน 1 ล้าน", rateKey: "1m", limit: "1,000,000" },
        { name: "แผน 5 ล้าน", rateKey: "5m", limit: "5,000,000" },
        { name: "แผน 15 ล้าน", rateKey: "15m", limit: "15,000,000" },
        { name: "แผน 25 ล้าน", rateKey: "25m", limit: "25,000,000" }
      ]
    }
  },

  state: {
    1: { type: "HS", idx: 0 },
    2: { type: "HSV", idx: 0 },
    3: { type: "HH", idx: 0 }
  },

  expandHSRow(row_11_20, row_21_35, row_36_40, row_41_45, row_46_50, row_51_55, row_56_60, row_61_65, row_66_70, row_71_75, row_76_80, row_81_85, row_86_90, row_91_95, row_96_98) {
    return [
      row_11_20, row_11_20,
      row_21_35, row_21_35, row_21_35,
      row_36_40,
      row_41_45,
      row_46_50,
      row_51_55,
      row_56_60,
      row_61_65,
      row_66_70,
      row_71_75,
      row_76_80,
      row_81_85,
      row_86_90,
      row_91_95,
      row_96_98
    ];
  },

  rateTable: {
    HS: { ageBands: "STD", male: {}, female: {} },

    HSX: { ageBands: "STD",
      male: {
        "1500":[7060,7330,7780,8540,10890,15270,22410,31530,47040,67730,94820,104300,114730,126200,126200,126200,126200,126200],
        "2000":[8900,9200,9710,10530,13680,18830,26510,37460,55280,79600,111430,122570,134830,148310,148310,148310,148310,148310],
        "2500":[10270,10780,11550,12470,16800,21820,29820,42550,62490,89980,125970,138570,152430,167670,167670,167670,167670,167670],
        "3500":[13040,13070,13800,15620,21580,31900,44080,62140,85460,123060,172280,189510,208460,229310,229310,229310,229310,229310],
        "4500":[15680,15720,16550,18860,26530,38650,54090,77250,106810,153800,215320,236850,260540,286590,286590,286590,286590,286590],
        "5500":[17690,17850,18290,21060,29750,44240,61730,88020,121700,175250,245340,269870,296860,326550,326550,326550,326550,326550],
        "6500":[19280,19270,19860,22660,32010,48190,67360,96040,132630,190980,267370,294110,323520,355870,355870,355870,355870,355870]
      },
      female: {
        "1500":[9170,9420,10050,11080,13790,17970,23990,33060,47540,68460,95840,105420,115960,127560,127560,127560,127560,127560],
        "2000":[11330,11800,12610,13760,16730,21880,28910,39360,56580,81480,114060,125470,138020,151820,151820,151820,151820,151820],
        "2500":[13030,14070,15070,16880,20160,25290,34030,45860,64620,93050,130270,143300,157630,173390,173390,173390,173390,173390],
        "3500":[17330,17970,19310,22380,26830,34000,46090,62780,86810,125010,175010,192510,211760,232940,232940,232940,232940,232940],
        "4500":[21030,21500,23190,27160,32920,42170,57150,77480,108830,156720,219400,241340,265470,292020,292020,292020,292020,292020],
        "5500":[23550,23820,25720,30190,36760,48190,67060,96040,132630,178070,249300,274230,301650,331820,331820,331820,331820,331820],
        "6500":[25080,25510,27580,32400,39370,51340,71040,96180,134860,194200,271880,299070,328980,361880,361880,361880,361880,361880]
      }
    },

    HSV: { ageBands: "STD",
      male: {
        "200k":[10100,7300,6900,7400,7500,8500,10000,11800,15400,20600,27300,37500,53700,76900,110200,121200,133300,146600],
        "300k":[12300,8700,8400,8900,9300,10200,11400,13000,17200,24200,31000,47100,67400,96600,138500,152400,167600,184400],
        "400k":[16400,10600,10400,13500,14700,15200,17100,18000,24300,30700,47000,65000,94400,135200,193800,222900,256300,294700],
        "500k":[20200,13700,13400,16600,18900,20100,21600,24700,30900,40500,56600,81000,115800,165600,236800,272300,313100,360100]
      },
      female: {
        "200k":[8500,7400,8600,9100,9200,10400,12100,14300,15500,20800,27600,37900,54200,77700,111300,122400,134600,148100],
        "300k":[10500,9700,10600,11300,11700,11900,13800,16000,17200,24400,31300,47600,68100,97600,139900,153900,169300,186200],
        "400k":[14100,12000,14400,17100,18000,18500,21700,23200,25600,31000,47500,66600,95300,136600,195700,225100,258900,297700],
        "500k":[18200,15000,18100,21000,22700,25100,26500,29200,34100,40900,57200,81800,117000,167300,239200,275100,316400,363900]
      }
    },

    HH: { ageBands: "HH_SPECIAL",
      male: {
        "1m":[16400,13500,13700,14700,15100,17000,19200,21600,28300,34100,40900,59400,85400,122900,177800,204500,235200,270500],
        "5m":[20200,16500,16900,18300,18900,20800,23800,26700,35000,42300,50600,72100,104000,150000,217100,249700,287200,330300],
        "15m":[25500,20100,21600,26100,29400,31800,36000,40200,50100,63900,72300,105000,152100,219900,318300,366000,420900,484200],
        "25m":[33400,26200,28000,33800,37800,40900,47300,52400,65300,83000,94100,136700,197800,286300,414700,476900,548400,630700]
      },
      female: {
        "1m":[14400,15200,17200,17500,18400,20400,22300,24500,28500,34400,41500,60800,88200,126300,182700,210100,241600,277800],
        "5m":[18200,19100,21500,21800,22700,25100,27800,30400,35200,42500,50800,74000,107500,154400,223400,256900,295400,339700],
        "15m":[21600,23100,27000,30600,34200,37200,42900,46500,50700,65100,73500,107100,155700,224700,325500,374400,430500,495000],
        "25m":[27900,30300,35300,38000,42300,46000,53600,60700,65500,84600,95700,139300,202000,291800,422700,486100,559000,642900]
      }
    }
  },

  buildHSRateTablesFromImage() {
    // male rows: [1000,1600,2200,2800,3400,4000,5000]
    const m_11_20 = [4030,5400,6160,6790,8160,9520,11960];
    const m_21_35 = [3560,4760,5390,6020,7310,8500,10590];
    const m_36_40 = [4200,5640,6270,7000,8330,9940,12370];
    const m_41_45 = [4550,6120,6820,7630,9180,10760,13400];
    const m_46_50 = [4900,6600,7370,8190,9860,11500,14170];
    const m_51_55 = [6240,8400,9460,10360,12410,14780,17710];
    const m_56_60 = [8110,10960,12320,13510,16490,19400,23220];
    const m_61_65 = [10710,14240,16170,17850,21590,25160,30980];
    const m_66_70 = [15930,21200,24090,27090,32640,37760,45620];
    const m_71_75 = [24870,33200,37730,42280,50830,59140,72330];
    const m_76_80 = [39230,52440,59510,66710,80240,93480,115200];
    const m_81_85 = [54920,73400,83270,93380,112370,130880,161280];
    const m_86_90 = [60410,80740,91610,102750,123670,143970,177410];
    const m_91_95 = [66450,88810,100760,112990,135990,158370,195150];
    const m_96_98 = [73100,97690,110840,124310,149590,174210,214670];

    // female rows
    const f_11_20 = [4030,5400,6160,6790,8160,9520,11960];
    const f_21_35 = [4600,6200,7040,7700,9350,10960,13630];
    const f_36_40 = [5460,7200,8140,9030,10880,12700,15650];
    const f_41_45 = [5920,7800,8800,9800,11730,13740,16980];
    const f_46_50 = [6420,8520,9570,10500,12750,14820,18420];
    const f_51_55 = [8120,10800,12210,13580,16320,18860,23690];
    const f_56_60 = [10540,14120,15730,17570,21250,25000,30740];
    const f_61_65 = [13810,18520,20900,23240,27710,32700,40290];
    const f_66_70 = [20330,27560,31020,34860,41990,48200,60460];
    const f_71_75 = [31930,43160,48730,54670,65790,75940,95250];
    const f_76_80 = [50560,68200,77110,86310,103870,120480,151110];
    const f_81_85 = [70780,95480,107910,120820,145350,168680,211550];
    const f_86_90 = [77860,105030,118710,132920,159890,185550,232710];
    const f_91_95 = [85650,115530,130570,146220,175940,204110,255980];
    const f_96_98 = [94220,127080,143640,160850,193470,224520,281580];

    const maleExpanded = this.expandHSRow(m_11_20,m_21_35,m_36_40,m_41_45,m_46_50,m_51_55,m_56_60,m_61_65,m_66_70,m_71_75,m_76_80,m_81_85,m_86_90,m_91_95,m_96_98);
    const femaleExpanded = this.expandHSRow(f_11_20,f_21_35,f_36_40,f_41_45,f_46_50,f_51_55,f_56_60,f_61_65,f_66_70,f_71_75,f_76_80,f_81_85,f_86_90,f_91_95,f_96_98);

    const planKeys = ["1000","1600","2200","2800","3400","4000","5000"];
    planKeys.forEach((k, colIdx) => {
      this.rateTable.HS.male[k] = maleExpanded.map(r => r[colIdx]);
      this.rateTable.HS.female[k] = femaleExpanded.map(r => r[colIdx]);
    });
  },

  getBandIndexSTD(age) {
    if (age < 11) return 0;
    if (age <= 15) return 0;
    if (age <= 20) return 1;
    if (age <= 25) return 2;
    if (age <= 30) return 3;
    if (age <= 35) return 4;
    if (age <= 40) return 5;
    if (age <= 45) return 6;
    if (age <= 50) return 7;
    if (age <= 55) return 8;
    if (age <= 60) return 9;
    if (age <= 65) return 10;
    if (age <= 70) return 11;
    if (age <= 75) return 12;
    if (age <= 80) return 13;
    if (age <= 85) return 14;
    if (age <= 90) return 15;
    if (age <= 95) return 16;
    return 17;
  },

  getBandIndexHH(age) {
    if (age < 11) return 0;
    if (age <= 15) return 0;
    if (age <= 20) return 1;
    if (age <= 25) return 2;
    if (age <= 30) return 3;
    if (age <= 35) return 4;
    if (age <= 40) return 5;
    if (age <= 45) return 6;
    if (age <= 50) return 7;
    if (age <= 55) return 8;
    if (age <= 59) return 9;
    if (age <= 65) return 10;
    if (age <= 70) return 11;
    if (age <= 75) return 12;
    if (age <= 80) return 13;
    if (age <= 85) return 14;
    if (age <= 90) return 15;
    if (age <= 95) return 16;
    return 17;
  },

  getAgeBandsForType(type) { return (type === "HH") ? this.AGE_BANDS_HH : this.AGE_BANDS_STD; },
  getBandIndexForType(type, age) { return (type === "HH") ? this.getBandIndexHH(age) : this.getBandIndexSTD(age); },

  getPremium(type, gender, rateKey, bandIndex) {
    const arr = this.rateTable?.[type]?.[gender]?.[rateKey];
    if (!arr) return null;
    const v = arr[bandIndex];
    if (!v || v <= 0) return 0;
    return v;
  },

  validateRateTable() {
    const issues = [];
    Object.keys(this.plans).forEach(type => {
      const conf = this.plans[type];
      const t = this.rateTable[type];
      if (!t) { issues.push(`❌ Missing rateTable type: ${type}`); return; }

      const bands = this.getAgeBandsForType(type);
      const expectedLen = bands.length;

      ["male","female"].forEach(gender => {
        const g = t[gender];
        if (!g) { issues.push(`❌ Missing gender: ${type}.${gender}`); return; }

        conf.options.forEach(opt => {
          const arr = g[opt.rateKey];
          if (!arr) { issues.push(`❌ Missing plan: ${type}.${gender}.${opt.rateKey}`); return; }
          if (arr.length !== expectedLen) issues.push(`❌ Wrong length: ${type}.${gender}.${opt.rateKey} = ${arr.length} (ต้อง ${expectedLen})`);

          const zeroAt = [];
          arr.forEach((v,i)=>{ if (!v || v<=0) zeroAt.push(`${i}:${bands[i]}`); });
          if (zeroAt.length) issues.push(`⚠️ พบ 0/ว่าง: ${type}.${gender}.${opt.rateKey} => ${zeroAt.join(", ")}`);
        });
      });
    });

    const box = document.getElementById("validation-box");
    if (!issues.length) {
      box.innerHTML = `<span class="text-emerald-700">✅ ผ่าน: RateTable ครบถ้วน ไม่มีค่า 0</span>`;
      document.getElementById("validator-panel").classList.add("hidden");
      return;
    }

    box.innerHTML = `
      <div class="text-red-700 font-black mb-1">พบปัญหา ${issues.length} รายการ</div>
      <ul class="list-disc ml-5 space-y-1">${issues.slice(0, 8).map(x=>`<li>${x}</li>`).join("")}</ul>
      ${issues.length > 8 ? `<div class="mt-1 text-[11px]">...แสดงแค่ 8 รายการแรก</div>` : ""}
    `;

    const panel = document.getElementById("validator-panel");
    const body = document.getElementById("validator-body");
    body.innerHTML = issues.map(x => `<div class="mb-1">• ${x}</div>`).join("");
    panel.classList.remove("hidden");
  },

  toggleProMode() {
    this.ui.proMode = !this.ui.proMode;
    document.getElementById("sell-banner").classList.toggle("hidden", !this.ui.proMode);
    document.getElementById("pro-mode-label").innerText = `โหมดเซลล์มืออาชีพ: ${this.ui.proMode ? "ON" : "OFF"}`;
  },

  adjustFont(delta) {
    if (delta === 0) this.ui.fontScale = 0;
    else this.ui.fontScale = Math.max(-2, Math.min(4, this.ui.fontScale + delta));
    const base = 14 + this.ui.fontScale * 1.2;
    document.documentElement.style.fontSize = `${base}px`;
  },

  renderSelectors(col) {
    const cur = this.state[col];
    const typeSel = document.getElementById(`type-${col}`);
    const idxSel = document.getElementById(`idx-${col}`);
    typeSel.innerHTML = Object.keys(this.plans).map(k => `<option value="${k}" ${k===cur.type?'selected':''}>${this.plans[k].name}</option>`).join("");
    idxSel.innerHTML = this.plans[cur.type].options.map((o,i)=> `<option value="${i}" ${i===cur.idx?'selected':''}>${o.name}</option>`).join("");
  },

  updateHeader(col) {
    const { type, idx } = this.state[col];
    const plan = this.plans[type];
    const opt = plan.options[idx];
    document.getElementById(`head-${col}`).innerHTML = `
      <div class="fade-in">
        <div class="text-lg font-black text-gray-900">${plan.name}</div>
        <div class="text-base font-extrabold text-amber-700">${opt.name}</div>
        <div class="text-xs text-gray-500">${plan.subtitle}</div>
        <div class="mt-2">
          <span class="inline-block px-3 py-1 bg-white border border-gray-200 rounded-full text-xs font-black text-gray-700 shadow-sm">วงเงิน: ${opt.limit}</span>
        </div>
      </div>
    `;
    document.getElementById(`proj-head-${col}`).innerHTML =
      `<span class="text-xs block text-gray-400">${plan.name}</span><span class="text-sm font-black text-amber-700">${opt.name}</span>`;
  },

  changeType(col, newType) {
    this.state[col].type = newType;
    this.state[col].idx = 0;
    this.renderSelectors(col);
    this.updateHeader(col);
    this.reCalculate();
  },

  changeOption(col, newIdx) {
    this.state[col].idx = parseInt(newIdx,10);
    this.updateHeader(col);
    this.reCalculate();
  },

  reCalculate() {
    const gender = document.getElementById("input-gender").value;
    let age = parseInt(document.getElementById("input-age").value || "11", 10);
    if (isNaN(age) || age < 11) age = 11;
    if (age > 98) age = 98;
    document.getElementById("input-age").value = age;

    const debugType = this.state[1].type;
    const bands = this.getAgeBandsForType(debugType);
    const idx = this.getBandIndexForType(debugType, age);
    document.getElementById("debug-band").innerText = `จับคู่ช่วงอายุ: อายุ ${age} → ${bands[idx]} (index ${idx})`;

    [1,2,3].forEach(col => {
      const { type, idx } = this.state[col];
      const opt = this.plans[type].options[idx];
      const bandIndex = this.getBandIndexForType(type, age);
      const prem = this.getPremium(type, gender, opt.rateKey, bandIndex);

      const el = document.getElementById(`prem-${col}`);
      if (prem === null) el.innerHTML = "-";
      else if (prem === 0) el.innerHTML = `<span class="text-red-600">ตรวจ Rate</span>`;
      else el.innerHTML = prem.toLocaleString();

      el.classList.remove("fade-in");
      void el.offsetWidth;
      el.classList.add("fade-in");
    });

    this.renderPremiumTable(age, gender);
    this.validateRateTable();
    lucide.createIcons();
  },

  // ✅ FIXED + ✅ AGE BAND FONT RED
  renderPremiumTable(age, gender) {
    const baseType = this.state[1].type;
    const bands = this.getAgeBandsForType(baseType);
    const startIdx = this.getBandIndexForType(baseType, age);

    const parseBandStartAge = (bandLabel) => {
      const clean = bandLabel.replace("*", "");
      const start = parseInt(clean.split("-")[0], 10);
      return isNaN(start) ? 11 : start;
    };

    let html = "";
    for (let i = startIdx; i < bands.length; i++) {
      const bandLabel = bands[i];
      const bandStartAge = parseBandStartAge(bandLabel);

      const premiums = [1,2,3].map(col => {
        const { type, idx } = this.state[col];
        const opt = this.plans[type].options[idx];
        const bandIndex = this.getBandIndexForType(type, bandStartAge);
        return this.getPremium(type, gender, opt.rateKey, bandIndex);
      });

      html += `
        <tr class="${i===startIdx ? 'bg-yellow-50 font-black border-l-4 border-yellow-400' : ''}">
          <td class="p-3 border-b border-gray-100 text-red-600 font-extrabold">${bandLabel}</td>
          ${premiums.map(v => `
            <td class="p-3 border-b border-gray-100 ${(v===0||v===null)?'text-red-600 font-black':'text-slate-700 font-bold'}">
              ${(v===0||v===null)?'-':v.toLocaleString()}
            </td>
          `).join("")}
        </tr>
      `;
    }

    document.getElementById("premium-table-body").innerHTML = html;
  },

  renderBody() {
    const tbl = document.getElementById("table-body");
    tbl.innerHTML = `
      <tr class="bg-gray-100 border-y border-gray-200">
        <td colspan="4" class="py-2 px-4 text-xs font-black text-gray-600 uppercase tracking-wide">หมายเหตุ</td>
      </tr>
      <tr>
        <td class="p-3 pl-4 border-r border-gray-100 bg-white sticky-col z-10">
          <div class="flex items-center gap-2 font-semibold text-gray-700">
            <i data-lucide="check-circle" class="w-4 h-4 text-emerald-600"></i>
            FINAL: FIX mapping ไม่ข้ามช่วง + ช่วงอายุสีแดง (ตารางเบี้ยต่อเนื่อง)
          </div>
          <div class="text-[11px] text-gray-500 mt-1 ml-6">
            HS หน้า 3 เติมเบี้ยครบแล้วจากภาพ และตารางต่อเนื่องแยก bandIndex ตาม type ของแต่ละแผน
          </div>
        </td>
        <td class="p-3 text-center border-l border-gray-100">-</td>
        <td class="p-3 text-center border-l border-gray-100">-</td>
        <td class="p-3 text-center border-l border-gray-100">-</td>
      </tr>
    `;
  },

  init() {
    this.buildHSRateTablesFromImage();
    [1,2,3].forEach(col => {
      this.renderSelectors(col);
      this.updateHeader(col);
    });
    this.renderBody();
    this.reCalculate();
    lucide.createIcons();
  }
};

document.addEventListener("DOMContentLoaded", () => app.init());
</script>

</body>
</html>
